---
/**
 * ValuesTabs Component
 * 
 * Renders a tabbed interface to display a set of values or features.
 * This component is designed to be fully self-contained for interactivity,
 * relying on an inline script and global CSS classes for styling and behavior.
 * 
 * It includes two views:
 * 1. A horizontal tab list for desktop screens.
 * 2. A dropdown/select menu for mobile screens.
 * 
 * The component's interactivity is handled by a vanilla JavaScript inline script
 * that manages the 'active' state for tabs and content panels.
 */

// Defines the data structure for a single tab item.
export interface TabItem {
  id: string; // Unique identifier for the tab, used for linking and targeting.
  title: string; // The text displayed in the tab button.
  content: string; // The HTML content to be displayed in the tab panel.
  active?: boolean; // Optional: If true, this tab will be active on initial load.
}

// Defines the props accepted by the ValuesTabs component.
export interface Props {
  summaryTitle: string; // Title for the summary section displayed next to the tabs.
  summaryDescription: string; // Description for the summary section.
  tabs: TabItem[]; // An array of tab items to be rendered.
}

const { summaryTitle, summaryDescription, tabs } = Astro.props;

// Server-side logic to determine the initially active tab.
// It looks for a tab with the `active: true` flag. If none is found,
// it defaults to the very first tab in the array.
// This ensures that the component always has a valid active state on load.
const initialActiveTabId = tabs.find(tab => tab.active)?.id || tabs[0]?.id;
---

{/* 
  Root container for the tabbed component. 
  The `id` is used by the inline script to scope its functionality.
*/}
<div class="tabbed__block" id="tabbed-component">
    <div class="wrap">
        <div class="tabbed__block-container small-12">
            {/* Left-side summary column */}
            <div class="tabbed__summary col small-12 medium-4">
                <h3 class="tabbed__summary-title h300">
                    {summaryTitle}
                </h3>
                <p class="tabbed__summary-description" set:html={summaryDescription}></p>
            </div>
            {/* Right-side tabs column */}
            <div class="tabbed__tabs col small-12 medium-8">
                {/* Desktop: Horizontal list of tab links */}
                <div class="tabbed__tabs-list">
                    {tabs.map((tab) => (
                        <a
                            class:list={["tabbed__tabs-list-item", { "active": tab.id === initialActiveTabId }]}
                            data-target={tab.id}
                            role="tab"
                            tabindex="0"
                            ga4-component-tracking={`{"event":"component_click","type":"Tabbed Component Tab Click","title":"${tab.title}"}`}
                        >
                            {tab.title}
                        </a>
                    ))}
                </div>
                {/* Mobile: Dropdown select menu */}
                <div class="tabbed__tabs-dropdown">
                    <select class="form-select" data-val="true" data-val-required="The Tabbed Sections field is required." id="tabDropdown" name="CurrentPage.Body.TabbedComponentContent">
                        {tabs.map((tab) => (
                            <option value={tab.id} selected={tab.id === initialActiveTabId}>
                                {tab.title}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Container for all tab content panels */}
                <div class="tabbed__content">
                    {tabs.map((tab) => (
                        <div
                            id={tab.id}
                            class:list={["tabbed__content-container", { "active": tab.id === initialActiveTabId }]}
                            role="tabpanel"
                        >
                            <div class="editor" set:html={tab.content}></div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </div>
</div>

{/*
  This inline script provides the client-side interactivity for the tabs.
  `is:inline` ensures the script is placed directly into the HTML and is not
  processed by Astro. This makes it independent of Astro's island architecture.

  The script does the following:
  1. Finds the component's root element by its ID.
  2. Gathers all tab links and content panels.
  3. Defines a function `activateTab` to manage the 'active' class on the correct
     link and content panel, ensuring only one is visible at a time.
  4. Attaches 'click' event listeners to the desktop tab links.
  5. Attaches a 'change' event listener to the mobile dropdown.
  6. It runs after the DOM is fully loaded to ensure all elements are available.
*/}
<script is:inline>
  (function() {
    function initTabbedComponent() {
      const tabbedBlock = document.getElementById('tabbed-component');
      if (!tabbedBlock) return;

      const tabLinks = tabbedBlock.querySelectorAll('.tabbed__tabs-list-item');
      const tabContents = tabbedBlock.querySelectorAll('.tabbed__content-container');
      const tabDropdown = tabbedBlock.querySelector('#tabDropdown');

      function activateTab(targetId) {
        // Deactivate all links and content
        tabLinks.forEach(link => link.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Activate the selected link
        const activeLink = tabbedBlock.querySelector(`.tabbed__tabs-list-item[data-target="${targetId}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }

        // Activate the selected content
        const activeContent = tabbedBlock.querySelector(`#${targetId}`);
        if (activeContent) {
          activeContent.classList.add('active');
        }

        // Update dropdown selection
        if (tabDropdown) {
          tabDropdown.value = targetId;
        }
      }

      // Event listener for tab links
      tabLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const targetId = this.getAttribute('data-target');
          activateTab(targetId);
        });
      });

      // Event listener for dropdown
      if (tabDropdown) {
        tabDropdown.addEventListener('change', function() {
          const targetId = this.value;
          activateTab(targetId);
        });
      }

      // Set initial active tab based on props (handled by Astro class:list)
      // If no active tab is set in props, default to the first one
      const initiallyActiveLink = tabbedBlock.querySelector('.tabbed__tabs-list-item.active');
      if (!initiallyActiveLink && tabLinks.length > 0) {
        activateTab(tabLinks[0].getAttribute('data-target'));
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTabbedComponent);
    } else {
      initTabbedComponent();
    }
  })();
</script>
